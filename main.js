!function(){"use strict";function e(e,t){return 0===e?"top-left":e===t-1?"top-right":e<t-1&&e>0?"top":e===t*t-t?"bottom-left":e===t*t-1?"bottom-right":e<t*t-1&&e>t*t-t?"bottom":e%t==0?"left":(e+1)%t==0?"right":"center"}class t{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(t){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(t);for(let t=0;t<this.boardSize**2;t+=1){const a=document.createElement("div");a.classList.add("cell","map-tile",`map-tile-${e(t,this.boardSize)}`),a.addEventListener("mouseenter",(e=>this.onCellEnter(e))),a.addEventListener("mouseleave",(e=>this.onCellLeave(e))),a.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(a)}this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const a of e){const e=this.boardEl.children[a.position],s=document.createElement("div");s.classList.add("character",a.character.type);const i=document.createElement("div");i.classList.add("health-level");const r=document.createElement("div");r.classList.add("health-level-indicator","health-level-indicator-"+((t=a.character.health)<15?"critical":t<50?"normal":"high")),r.style.width=`${a.character.health}%`,i.appendChild(r),s.appendChild(i),e.appendChild(s)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((a=>{const s=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),s.appendChild(i),i.addEventListener("animationend",(()=>{s.removeChild(i),a()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}var a="prairie",s="desert",i="arctic",r="mountain";class l{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if(this.level=e,this.attack=0,this.defence=0,this.health=50,this.type=t,"Character"===new.target.name)throw new Error('Нельзя создать класс "Character"')}}class n extends l{constructor(e){super(e,"bowman"),this.attack=25,this.defence=25}}class h extends l{constructor(e){super(e,"swordsman"),this.attack=40,this.defence=10}}class c extends l{constructor(e){super(e,"magician"),this.attack=10,this.defence=40}}class o extends l{constructor(e){super(e,"undead"),this.attack=40,this.defence=10}}class d extends l{constructor(e){super(e,"daemon"),this.attack=10,this.defence=10}}class m extends l{constructor(e){super(e,"vampire"),this.attack=25,this.defence=25}}class u{constructor(e){this.characters=e}}function*p(e,t){const a=e[Math.floor(Math.random()*e.length)],s=Math.floor(Math.random()*t)+1;"bowman"===a&&(yield new n(s)),"swordsman"===a&&(yield new h(s)),"magician"===a&&(yield new c(s)),"undead"===a&&(yield new o(s)),"daemon"===a&&(yield new d(s)),"vampire"===a&&(yield new m(s))}function g(e,t,a){const s=[];for(let i=0;i<a;i++)s.push(p(e,t).next().value);return new u(s)}function f(e,t,a){let s=0;const i=[];"player"===e&&(s=0),"computer"===e&&(s=a-2);for(let e=0;e<a;e++){let r=e*a+s,l=e*a+s+1;t.includes(r)||i.push(r),t.includes(l)||i.push(l)}return i[Math.floor(Math.random()*i.length)]}function v(t,a,s,i){let r,l=[],n=function(e,t,a,s){let i;return"top"===t&&(i=a-s*e),"bottom"===t&&(i=a+s*e),"left"===t&&(i=a-e),"right"===t&&(i=a+e),"top-left"===t&&(i=a-s*e-e),"top-right"===t&&(i=a-s*e+e),"bottom-left"===t&&(i=a+s*e-e),"bottom-right"===t&&(i=a+s*e+e),i};if("center"===e(a,s)){for(let h=1;h<=t.length&&(r=n(h,i,a,s),l.push(r),"center"===e(r,s));h++);return l}if("top"===e(a,s)||"left"===e(a,s)||"right"===e(a,s)||"bottom"===e(a,s)){for(let h=1;h<=t.length;h++){if(r=n(h,i,a,s),e(r,s)!==e(a,s)&&"center"!==e(r,s)){l.push(r);break}l.push(r)}return l}for(let e=1;e<=t.length;e++)r=n(e,i,a,s),l.push(r);return l}function w(t,a,s){let i=[],r=[],l=["top","top-right","top-left","left","right","bottom","bottom-left","bottom-right"];if("swordsman"!==a&&"undead"!==a||(i=[1]),"bowman"!==a&&"vampire"!==a||(i=[1,2]),"magician"!==a&&"daemon"!==a||(i=[1,2,3,4]),e(t,s).includes("-")){let a=e(t,s).split("-");l.filter((e=>!e.includes(a[0]))).filter((e=>!e.includes(a[1]))).forEach((e=>r.push(...v(i,t,s,e))))}else"center"===e(t,s)?l.forEach((e=>r.push(...v(i,t,s,e)))):l.filter((a=>!a.includes(e(t,s)))).forEach((e=>r.push(...v(i,t,s,e))));return r}function C(t,a,s,i){let r,l=[],n=function(e,t,a,s){let i;return"top"===t&&(i=a-s*e),"bottom"===t&&(i=a+s*e),"left"===t&&(i=a-e),"right"===t&&(i=a+e),i};if("top-right"===e(a,s)||"top-left"===e(a,s)||"bottom-right"===e(a,s)||"bottom-left"===e(a,s)){for(let e=1;e<=t.length;e++)r=n(e,i,a,s),l.push(r);return l}for(let h=1;h<=t.length;h++){if(r=n(h,i,a,s),e(r,s)!==e(a,s)&&"center"!==e(r,s)){l.push(r);break}l.push(r)}return l}function L(t,a,s){let i=[],r=[],l=[];return"swordsman"!==a&&"undead"!==a||(i=[1]),"bowman"!==a&&"vampire"!==a||(i=[1,2]),"magician"!==a&&"daemon"!==a||(i=[1,2,3,4]),"top-right"===e(t,s)||"top-left"===e(t,s)||"top"===e(t,s)?(l.push(...C(i,t,s,"bottom")),l.push(t)):"bottom-right"===e(t,s)||"bottom-left"===e(t,s)||"bottom"===e(t,s)?(l.push(...C(i,t,s,"top")),l.push(t)):(l.push(...C(i,t,s,"top")),l.push(...C(i,t,s,"bottom")),l.push(t)),"top-right"===e(t,s)||"right"===e(t,s)||"bottom-right"===e(t,s)?l.forEach((e=>r.push(...C(i,e,s,"left")))):"top-left"===e(t,s)||"left"===e(t,s)||"bottom-left"===e(t,s)?l.forEach((e=>r.push(...C(i,e,s,"right")))):(l.forEach((e=>r.push(...C(i,e,s,"right")))),l.forEach((e=>r.push(...C(i,e,s,"left"))))),r.push(...l),r.filter((e=>e!=t))}class y{constructor(e,t){if(!(e instanceof l))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}var S="auto",b="pointer",E="crosshair",k="not-allowed";class P{constructor(){this.turn="player",this.selectedCell=0,this.selectedCharacter=0,this.level=1,this.running=!0}changeTurn(){"player"===this.turn?this.turn="compuetr":this.turn="player"}}const G=new t;G.bindToDOM(document.querySelector("#game-container"));const T=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage),M=new class{constructor(e,t){this.boardSize=8,this.gamePlay=e,this.gameState=new P,this.stateService=t,this.characterList=[]}init(){this.startNewGame(),this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addNewGameListener(this.startNewGame.bind(this)),this.gamePlay.addSaveGameListener(this.saveGame.bind(this)),this.gamePlay.addLoadGameListener(this.loadGame.bind(this))}onCellClick(e){const a=this.characterList.find((t=>t.position===e)),s=w(this.gameState.selectedCell,this.gameState.selectedCharacter,this.boardSize),i=L(this.gameState.selectedCell,this.gameState.selectedCharacter,this.boardSize);if("player"===this.gameState.turn&&this.gameState.running)if(a)if("bowman"===a.character.type||"swordsman"===a.character.type||"magician"===a.character.type)this.gamePlay.deselectCell(this.gameState.selectedCell),this.gamePlay.selectCell(e,"yellow"),this.gameState.selectedCell=e,this.gameState.selectedCharacter=a.character.type;else if(i.indexOf(e)>=0){let s=this.characterList.find((e=>e.position===this.gameState.selectedCell)).character,i=a.character,r=Math.max(.2*(s.attack-i.defence),.1*s.attack);if(r=Math.floor(r),i.health-=r,i.health<1&&(this.characterList=this.characterList.filter((t=>t.position!==e))),this.gamePlay.redrawPositions(this.characterList),this.gameState.changeTurn(),this.gamePlay.showDamage(e,r).then((()=>{setTimeout((()=>{this.computerTurn()}),1e3)})),0===this.teamSize("computer")){if(4===this.gameState.level)return this.gameState.running=!1,void t.showMessage("Победа");this.gameState.level+=1,this.gameState.selectedCell=0,this.gameState.selectedCharacter=0,this.characterList=[],this.levelUp(),this.startNextLevel()}}else t.showError("Нельзя выбрать персонажей противника");else s.indexOf(e)>=0?(this.characterList.map((t=>{t.position===this.gameState.selectedCell&&(t.position=e,this.gamePlay.deselectCell(this.gameState.selectedCell),this.gameState.selectedCell=e,this.gamePlay.selectCell(e,"yellow"))})),this.gamePlay.redrawPositions(this.characterList),this.gameState.changeTurn(),setTimeout((()=>{this.computerTurn()}),1e3)):t.showError("Пустая клетка")}onCellEnter(e){const t=this.characterList.find((t=>t.position===e)),a=w(this.gameState.selectedCell,this.gameState.selectedCharacter,this.boardSize),s=L(this.gameState.selectedCell,this.gameState.selectedCharacter,this.boardSize);if(t){const a=this.characterInfo(t);this.gamePlay.setCursor(b),this.gamePlay.showCellTooltip(a,e),"undead"!==t.character.type&&"vampire"!==t.character.type&&"daemon"!==t.character.type||(s.indexOf(e)>=0?this.gamePlay.setCursor(E):this.gamePlay.setCursor(k))}else a.indexOf(e)>=0&&(this.gamePlay.selectCell(e,"green"),this.gamePlay.setCursor(b))}onCellLeave(e){this.gamePlay.hideCellTooltip(e),this.gamePlay.setCursor(S),e!==this.gameState.selectedCell&&this.gamePlay.deselectCell(e)}startNewGame(){this.clearAll(),this.startNextLevel()}fieldRendering(e){let t="";1===e&&(t=a),2===e&&(t=s),3===e&&(t=i),4===e&&(t=r),this.gamePlay.drawUi(t)}generateNewTeam(e){"player"===e&&(this.playerTeam=g(["bowman","swordsman","magician"],this.gameState.level,3)),"computer"===e&&(this.computerTeam=g(["vampire","undead","daemon"],this.gameState.level,3))}positionTeam(e){let t;const a=[];"player"===e&&(t=this.playerTeam.characters),"computer"===e&&(t=this.computerTeam.characters);for(let s of t){const t=f(e,a,this.boardSize);a.push(t);const i=new y(s,t);this.characterList.push(i)}}drawingCharacters(){this.gamePlay.redrawPositions(this.characterList)}characterInfo(e){return`🎖${e.character.level} ⚔${e.character.attack} 🛡${e.character.defence} ❤${e.character.health}`}levelUp(){let e=0;for(let t of this.characterList){const a=t.character;a.level+=1,a.attack=Math.max(a.attack,a.attack*(80+a.health)/100),a.attack=Math.floor(a.attack),a.defence=Math.max(a.defence,a.defence*(80+a.health)/100),a.defence=Math.floor(a.defence),a.health=a.health+80<=100?a.health+80:100,t.character=a,this.characterList[e]=t,e++}}startNextLevel(){this.fieldRendering(this.gameState.level),this.generateNewTeam("computer"),this.generateNewTeam("player"),this.positionTeam("player"),this.positionTeam("computer"),this.drawingCharacters()}teamSize(e){let t=0;if("player"===e){for(const e of this.characterList)"bowman"!==e.character.type&&"swordsman"!==e.character.type&&"magician"!==e.character.type||(t+=1);return t}if("computer"===e){for(const e of this.characterList)"undead"!==e.character.type&&"vampire"!==e.character.type&&"daemon"!==e.character.type||(t+=1);return t}}computerTurn(){const e=[],a=[],s=[],i=[];for(let r of this.characterList){"bowman"!==r.character.type&&"swordsman"!==r.character.type&&"magician"!==r.character.type||(e.push(r),s.push(r.position)),"undead"!==r.character.type&&"vampire"!==r.character.type&&"daemon"!==r.character.type||(a.push(r),i.push(r.position));for(let s of a){const a=s.character,i=L(s.position,s.character.type,this.boardSize);for(let s of e)if(i.indexOf(s.position)>=0){let e=s,i=Math.max(.2*(a.attack-e.character.defence),.1*a.attack);if(i=Math.floor(i),e.character.health-=i,e.character.health<1&&(this.gamePlay.deselectCell(e.position),this.characterList=this.characterList.filter((t=>t.position!==e.position)),this.gamePlay.redrawPositions(this.characterList)),0===this.teamSize("player")){if(4===this.gameState.level)return this.gameState.running=!1,void t.showMessage("Вы проиграли");this.gameState.level+=1,this.levelUp(),this.gamePlay.deselectCell(this.gameState.selectedCell),this.startNextLevel()}return void this.gamePlay.showDamage(e.position,i).then((()=>{setTimeout((()=>{this.gameState.changeTurn()}),1e3)}))}}}let r=Math.floor(Math.random()*a.length);const l=a[r];let n=w(l.position,l.character.type,this.boardSize);n=n.filter((e=>!i.includes(e))),r=Math.floor(Math.random()*n.length),l.position=n[r],this.gamePlay.redrawPositions(this.characterList),this.gameState.changeTurn()}clearAll(){this.playerTeam=[],this.computerTeam=[],this.characterList=[],this.gameState.level=1,this.gameState.running=!0}saveGame(){const e={};e.running=this.gameState.running,e.level=this.gameState.level,e.turn=this.gameState.turn,e.selectedCell=this.gameState.selectedCell,e.selectedCharacter=this.gameState.selectedCharacter,e.characterList=this.characterList,this.stateService.save(e),t.showMessage("Игра сохранена")}loadGame(){try{const e=this.stateService.load();this.gameState.running=e.running,this.gameState.level=e.level,this.gameState.turn=e.turn,this.gamePlay.deselectCell(this.gameState.selectedCell),this.gameState.selectedCell=e.selectedCell,this.gameState.selectedCell&&this.gamePlay.selectCell(this.gameState.selectedCell,"yellow"),this.gameState.selectedCharacter=e.selectedCharacter,this.characterList=[],e.characterList.map((e=>{const t=(a=e.character.level,"bowman"===(s=e.character.type)?new n(a,"bowman"):"swordsman"===s?new h(a,"swordsman"):"magician"===s?new c(a,"magician"):"undead"===s?new o(a,"undead"):"vampire"===s?new m(a,"vampire"):"daemon"===s?new d(a,"daemon"):void 0);var a,s;t.attack=e.character.attack,t.defence=e.character.defence,t.health=e.character.health;const i=new y(t,e.position);this.characterList.push(i)})),this.fieldRendering(this.gameState.level),this.gamePlay.redrawPositions(this.characterList),t.showMessage("Игра загружена")}catch{t.showError("Нет сохранённой игры")}}}(G,T);M.init()}();